<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      font-family: Arial, sans-serif;
      font-size: small;
      padding: 20px;
      background-color: #f2f2f2;
      /* Light Grey Background */
    }

    h2 {
      color: #333;
    }

    label {
      display: block;
      margin-top: 5px;
      margin-bottom: 10px;
      font-weight: normal;
    }

    input[type="file"] {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
    }

    input[type="number"] {
      width: 100px;
      padding: 5px;
      margin-bottom: 10px;
    }

    button {
      background-color: #0073e6;
      color: #fff;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }

    #cancel {
      background-color: #ccc;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      margin-top: 25px;
    }

    .checkbox-label {
      margin-left: 5px;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .left {
      width: 48%;
    }

    .right {
      width: 48%;
    }

    .top {
      margin-bottom: 10px;
    }

    .bottom {
      margin-top: 10px;
    }

    .tab {
      display: none;
      height: 150px;
      overflow-y: auto;
    }

    .tab.active {
      display: block;
    }

    .tab-links {
      margin-bottom: 10px;
    }

    .tab-links a {
      display: inline-block;
      padding: 10px;
      background-color: #ccc;
      color: #333;
      text-decoration: none;
      border-radius: 5px 5px 0 0;
      margin-right: 10px;
    }

    .tab-links a.active {
      background-color: #0073e6;
      color: #fff;
    }

    #buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .drawing-options-header {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .drawing-options {
      margin-top: 10px;
    }
  </style>
  <title>Magic Image Import</title>
</head>

<body>
  <div id="message-box"></div>
  <div class="tab-links">
    <a href="#" class="active" data-tab="from-files">From Files</a>
    <a href="#" data-tab="from-table">From Table</a>
  </div>
  <div class="tab active" id="from-files">
    <div class="container top">
      <div class="left">
        <label for="folder">Select Files:</label>
        <input type="file" id="files" multiple>
      </div>
    </div>
  </div>
  <div class="tab" id="from-table">
    <div class="container top">
      <div class="left">
        <label for="table-file">Select Table File:</label>
        <input type="file" id="table-file">
      </div>
      <div class="right">
        <label for="spreadsheet">Spreadsheet:</label>
        <select id="spreadsheet">
          <option value="">Select Spreadsheet</option>
        </select>
      </div>
    </div>
    <div class="container bottom">
      <div class="left">
        <label for="column-image-paths">Image Path Column :</label>
        <select id="column-image-paths">
          <option value="">Select Column</option>
        </select>
      </div>
      <div class="right">
        <label for="column-image-size">Image Size Column:</label>
        <select id="column-image-size">
          <option value="">Select Column</option>
        </select>
      </div>
    </div>
  </div>
  <hr>
  <div class="drawing-options">
    <div class="drawing-options-header">Drawing Options</div>
    <div class="container top">
      <div class="left">
        <div class="checkbox-container">
          <input type="checkbox" id="add_text" checked>
          <label class="checkbox-label" for="add_text">Add Text</label>
        </div>
      </div>
      <div class="right">
        <label for="text_size">Text Size [mm]:</label>
        <input type="number" id="text_size" value="25">
      </div>
    </div>
    <div class="container bottom">
      <div class="left">
        <label for="spacing">Spacing [mm]:</label>
        <input type="number" id="spacing" value="100">
      </div>
      <div class="right">
        <label for="depth">Item depth [mm]:</label>
        <input type="number" id="depth" value="10">
      </div>
    </div>
  </div>
  <div class="buttons">
    <button id="ok">OK</button>
    <button id="cancel">Cancel</button>
  </div>
  <script src="xlsx.full.min.js"></script>
  <script>
    // LOG - Define a function to output messages to the message box
    function outputMessage(message) {
      var messageBox = document.getElementById("message-box");
      messageBox.innerHTML += message + "<br>";
    }

    function puts(message) {
      // Define parameters to send back to the Ruby callback
      var params = {
        message: message
      };
      // Send the callback to the Ruby script
      window.location = 'skp:puts_callback@' + encodeURIComponent(JSON.stringify(params));
    }


    // TABS - Define a function to handle tab switching
    function switchTab(event) {
      event.preventDefault();
      var clickedTab = event.target;
      var tabId = clickedTab.getAttribute("data-tab");
      var activeTab = document.querySelector(".tab.active");
      var activeTabLink = document.querySelector(".tab-links a.active");
      if (activeTab) {
        activeTab.classList.remove("active");
      }
      if (activeTabLink) {
        activeTabLink.classList.remove("active");
      }
      clickedTab.classList.add("active");
      document.getElementById(tabId).classList.add("active");
    }

    // TABS - Event listeners to tab links
    var tabLinks = document.querySelectorAll(".tab-links a");
    for (var i = 0; i < tabLinks.length; i++) {
      tabLinks[i].addEventListener("click", switchTab);
    }




    // The TABLE - Event listeners to handle the file input change
    document.getElementById("table-file").addEventListener("change", function () {
      clearDropdowns(); // Clear existing dropdowns
      var fileInput = document.getElementById("table-file");
      var fileName = fileInput.files[0].name;
      var fileExtension = fileName.split('.').pop().toLowerCase();
      if (fileExtension === "xls" || fileExtension === "xlsx") {
        // Load the Excel file
        var reader = new FileReader();
        reader.addEventListener("load", function (e) {
          var data = e.target.result;
          var workbook = XLSX.read(data, { type: 'binary' });
          // Get the sheet names
          var sheetNames = workbook.SheetNames;
          // Load the sheet names into the dropdown menu
          loadSheetNames(sheetNames, workbook);
        });
        reader.readAsBinaryString(fileInput.files[0]);
      } else {
        // Invalid file format
        alert("Invalid file format. Please select a CSV or Excel file.");
        fileInput.value = "";
      }
    });

    //function to load the sheet names into the dropdown menu
    function loadSheetNames(sheetNames, workbook) {
      // Clear the sheet dropdown menu
      clearDropdowns();
      // Load the sheet names into the dropdown menu
      var spreadsheetDropdown = document.getElementById("spreadsheet");
      for (var i = 0; i < sheetNames.length; i++) {
        var sheetName = sheetNames[i];
        var option = document.createElement("option");
        option.value = sheetName;
        option.text = sheetName;
        spreadsheetDropdown.add(option);
      }
      // Add an event listener to the spreadsheet dropdown menu
      var spreadsheetDropdown = document.getElementById("spreadsheet");
      spreadsheetDropdown.addEventListener("change", function () {
        // Get the selected sheet name
        var sheetName = this.value;
        // Get the worksheet for the selected sheet
        var worksheet = workbook.Sheets[sheetName];
        // Load the column names for the selected sheet
        loadColumnNames(getColumnNames(worksheet));
      });
    }

    // Function to get the column names from an Excel worksheet
    function getColumnNames(worksheet) {
      var columnNames = [];
      var range = XLSX.utils.decode_range(worksheet['!ref']);
      for (var C = range.s.c; C <= range.e.c; ++C) {
        var cell = worksheet[XLSX.utils.encode_cell({ r: range.s.r, c: C })];
        if (cell && cell.t) {
          columnNames.push(XLSX.utils.format_cell(cell));
        }
      }
      return columnNames;
    }

    // Function to load the column names into the dropdown menus
    function loadColumnNames(columnNames) {
      // Clear the dropdown menus
      clearColumnDropdowns();
      // Load the column names into the dropdown menus
      var columnDropdowns = document.querySelectorAll("*[id*='column-image']");
      for (var i = 0; i < columnDropdowns.length; i++) {
        var dropdown = columnDropdowns[i];
        for (var j = 0; j < columnNames.length; j++) {
          var columnName = columnNames[j];
          var option = document.createElement("option");
          option.value = columnName;
          option.text = columnName;
          dropdown.add(option);
        }
      }
    }

    // Function to clear the dropdown menus
    function clearDropdowns() {
      var sheetDropdown = document.getElementById("spreadsheet");
      sheetDropdown.innerHTML = '<option value="">Select Sheet</option>';
      clearColumnDropdowns();

    }

    function clearColumnDropdowns() {
      var imagePathsDropdown = document.getElementById("column-image-paths");
      var imageSizeDropdown = document.getElementById("column-image-size");
      imagePathsDropdown.innerHTML = '<option value="">Select Image Paths Column</option>';
      imageSizeDropdown.innerHTML = '<option value="">Select Image Size Column</option>';
    }


    /////////////////////
    // TU JEST CHUJNIA://
    /////////////////////

    // Function to extract a table with image paths and image sizes from an Excel file
    function extractTable(spreadsheet, columnImagePaths, columnImageSize) {
      return new Promise(function (resolve, reject) {
        var fileInput = document.getElementById("table-file");
        var selectedFile = fileInput.files[0];
        // Create a new FileReader object
        var reader = new FileReader();
        // Set up a callback function for when the file is loaded
        reader.addEventListener("load", function (e) {
          var data = e.target.result;
          var workbook = XLSX.read(data, { type: 'binary' });
          // extract sheet with given name
          var worksheet = workbook.Sheets[spreadsheet];
          // extract column names from first row
          var columnNames = [];
          var range = XLSX.utils.decode_range(worksheet['!ref']);
          for (var C = range.s.c; C <= range.e.c; ++C) {
            var cell = worksheet[XLSX.utils.encode_cell({ r: range.s.r, c: C })];
            if (cell && cell.t) {
              columnNames.push(XLSX.utils.format_cell(cell));
            }
          }
          // find indices of columnImagePaths and columnImageSize columns
          var columnImagePathsIndex = columnNames.indexOf(columnImagePaths);
          var columnImageSizeIndex = columnNames.indexOf(columnImageSize);
          // loop over rows of the table and extract the image paths and image sizes, output them as a list of lists
          var table = [];
          for (var R = range.s.r + 1; R <= range.e.r; ++R) {
            var row = [];
            var cell = worksheet[XLSX.utils.encode_cell({ r: R, c: columnImagePathsIndex })];
            if (cell && cell.t) {
              row.push(XLSX.utils.format_cell(cell));
            }
            var cell = worksheet[XLSX.utils.encode_cell({ r: R, c: columnImageSizeIndex })];
            if (cell && cell.t) {
              var sizeString = XLSX.utils.format_cell(cell);
              var sizeParts = sizeString.split('x');
              var size = [parseInt(sizeParts[0]), parseInt(sizeParts[1])];
              row.push(size);
            }
            table.push(row);
          }
          resolve(table);
        });
        // Set up a callback function for when an error occurs
        reader.addEventListener("error", function (e) {
          reject(e);
        });
        // Read the file as a binary string
        reader.readAsBinaryString(selectedFile);
      });
    }

  

    // Function to handle the OK button click
    document.getElementById("ok").addEventListener("click", function () {
      // Get the selected files
      puts('dupa')
      var selectedFiles = [];
      var fileInput = document.getElementById("files");
      for (var i = 0; i < fileInput.files.length; i++) {
        selectedFiles.push(fileInput.files[i].name);
      }

      var depthValue = document.getElementById("depth").value;   // Get the depth value
      var textSize = document.getElementById("text_size").value; // Get the text size
      var addText = document.getElementById("add_text").checked; // Get the add text checkbox value
      var spacing = document.getElementById("spacing").value; // Get the spacing value
      var tableFilePath = document.getElementById("table-file").value; // Get the table file path
      var spreadsheet = document.getElementById("spreadsheet").value; // Get the spreadsheet name
      var columnImagePaths = document.getElementById("column-image-paths").value; // Get the image paths column
      var columnImageSize = document.getElementById("column-image-size").value; // Get the image size column

      // Create an object to pass to the Ruby script
      var data = {
        files: selectedFiles,
        depth: depthValue,
        text_size: textSize,
        add_text: addText,
        spacing: spacing,
      };



      if (columnImagePaths && columnImageSize) {
        extractTable(spreadsheet, columnImagePaths, columnImageSize)
          .then(function (table) {
            // Add the table object to the data object
            data.table = table;
            // Send the data back to the Ruby script
            var encodedData = encodeURIComponent(JSON.stringify(data));
            window.location = 'skp:ok_callback@' + encodedData;
          })
          .catch(function (error) {
            // Handle the error
          });
      } else {
        data.table = null;
        // Send the data back to the Ruby script
        var encodedData = encodeURIComponent(JSON.stringify(data));
        window.location = 'skp:ok_callback@' + encodedData;
      }




    });


    // Function to handle the Cancel button click
    document.getElementById("cancel").addEventListener("click", function () {
        // Close the dialog
        puts('dupa2')
        window.location = 'skp:cancel_callback@';
      });


  </script>
</body>

</html>